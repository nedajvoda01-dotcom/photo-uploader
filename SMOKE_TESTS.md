# Smoke Tests - Production Fixes Verification

## Цель
Проверить все критические исправления production после деплоя.

## Предварительные условия
- Preview/Production deployment доступен
- Есть доступ к:
  - Admin аккаунт (region=ALL)
  - User аккаунт для региона R1
  - User аккаунт для региона R2
- Есть тестовые файлы:
  - Малый файл (<1MB) для upload
  - Большой файл (>50MB) для проверки лимитов
  - Batch файлов общим размером >200MB

## Тест 1: Логин Admin + User

### 1.1. Admin Login
**Шаги:**
1. Открыть страницу логина
2. Ввести admin credentials (region=ALL)
3. Нажать "Войти"

**Ожидаемый результат:**
- ✅ Успешная авторизация
- ✅ Редирект на главную страницу
- ✅ В интерфейсе видно переключатель региона

**Результат:** ⏳ PENDING

---

### 1.2. User Login
**Шаги:**
1. Logout из admin
2. Login как user (region=R1 или R2)
3. Проверить доступ

**Ожидаемый результат:**
- ✅ Успешная авторизация
- ✅ Виден только свой регион (без переключателя)

**Результат:** ⏳ PENDING

---

## Тест 2: Admin Создает Авто

### 2.1. Admin Выбирает activeRegion
**Шаги:**
1. Login как admin
2. Выбрать конкретный регион (например, R1) в переключателе
3. Нажать "Создать авто"

**Ожидаемый результат:**
- ✅ Форма создания открыта
- ✅ Регион предзаполнен выбранным значением (R1)

**Результат:** ⏳ PENDING

---

### 2.2. Admin Создает Авто без Ошибок
**Шаги:**
1. Заполнить форму:
   - Марка: Toyota
   - Модель: Camry
   - VIN: 1HGBH41JXMN109186 (17 символов)
   - Регион: R1 (выбранный)
2. Отправить форму

**Ожидаемый результат:**
- ✅ HTTP 201 Created
- ✅ Редирект на карточку авто `/cars/vin/1HGBH41JXMN109186`
- ✅ Нет ошибок в UI
- ✅ Если DB failed, показывается warning: "DB_CACHE_WRITE_FAILED"

**Результат:** ⏳ PENDING

**Проверить в response:**
```json
{
  "ok": true,
  "car": {
    "id": 123,
    "region": "R1",
    "make": "Toyota",
    "model": "Camry",
    "vin": "1HGBH41JXMN109186"
  }
  // Опционально: "warning": "DB_CACHE_WRITE_FAILED"
}
```

---

## Тест 3: User Создает Авто в Своем Регионе

**Шаги:**
1. Login как user (region=R2)
2. Создать авто:
   - Марка: Honda
   - Модель: Accord
   - VIN: 2HGFB2F50DH588752
   - Регион: (автоматически R2, без выбора)
3. Отправить форму

**Ожидаемый результат:**
- ✅ HTTP 201 Created
- ✅ Авто создано в region=R2
- ✅ Редирект на карточку авто

**Результат:** ⏳ PENDING

---

## Тест 4: Открыть Авто → 14 Слотов Видны

**Шаги:**
1. Открыть карточку созданного авто
2. Прокрутить вниз к секции "Слоты"

**Ожидаемый результат:**
- ✅ Видно ровно 14 слотов:
  - 1 слот "Дилер фото" (dealer)
  - 8 слотов "Выкуп фото" (buyout)
  - 5 слотов "Муляги фото" (dummies)
- ✅ Все слоты в статусе "empty" или "locked"
- ✅ Видно "Синхр: [дата]" или "last_sync_at"

**Результат:** ⏳ PENDING

**Проверить в API response:**
```json
{
  "ok": true,
  "car": {...},
  "slots": [...],  // 14 элементов
  "last_sync_at": "2026-02-07T22:00:00.000Z"
}
```

---

## Тест 5: Upload → Lock → Download ZIP

### 5.1. Upload Files
**Шаги:**
1. Выбрать слот (например, dealer slot)
2. Нажать "Upload"
3. Выбрать 2-3 изображения (<50MB каждое)
4. Загрузить

**Ожидаемый результат:**
- ✅ HTTP 200 OK
- ✅ Файлы загружены
- ✅ Слот переходит в статус "locked"
- ✅ Появляется _LOCK.json на диске

**Результат:** ⏳ PENDING

---

### 5.2. Download ZIP
**Шаги:**
1. На заблокированном слоте нажать "Download ZIP"
2. Скачать архив

**Ожидаемый результат:**
- ✅ Скачивается ZIP файл
- ✅ В архиве есть загруженные файлы
- ✅ Размер файлов соответствует

**Результат:** ⏳ PENDING

---

## Тест 6: Ручное Изменение на Диске → Refresh

### 6.1. Удалить _LOCK.json вручную
**Шаги:**
1. В Яндекс.Диске открыть слот
2. Удалить файл _LOCK.json
3. Вернуться в UI
4. Обновить страницу (F5)

**Ожидаемый результат:**
- ✅ После refresh статус слота изменился на "empty"
- ✅ Кнопка "Download ZIP" исчезла
- ✅ Видна новая дата синхронизации

**Результат:** ⏳ PENDING

---

### 6.2. Добавить _LOCK.json вручную
**Шаги:**
1. В Яндекс.Диске в пустом слоте создать файл _LOCK.json
2. Содержимое:
```json
{
  "locked_at": "2026-02-07T22:00:00Z",
  "locked_by": "manual@test.com",
  "file_count": 3,
  "total_size_mb": 15.5
}
```
3. Обновить страницу

**Ожидаемый результат:**
- ✅ Слот показывает статус "locked"
- ✅ Видны file_count и total_size_mb из _LOCK.json
- ✅ Появилась кнопка "Download ZIP"

**Результат:** ⏳ PENDING

---

## Тест 7: Archive Перемещает в /ALL/

**Шаги:**
1. Login как admin
2. Открыть карточку авто
3. Нажать "Archive" или DELETE /api/cars/vin/:vin
4. Подтвердить архивацию

**Ожидаемый результат:**
- ✅ HTTP 200 OK
- ✅ В response:
```json
{
  "success": true,
  "message": "Car archived successfully",
  "archivePath": "/Фото/ALL/R1_Toyota_Camry_1HGBH41JXMN109186"
}
```
- ✅ Папка перемещена в /ALL/
- ✅ В БД `deleted_at` установлен
- ✅ Авто исчезло из списка региона R1

**Результат:** ⏳ PENDING

---

## Тест 8: Проверка Лимитов Upload

### 8.1. Файл > 50MB
**Шаги:**
1. Попробовать загрузить файл размером 60MB

**Ожидаемый результат:**
- ✅ HTTP 413 Payload Too Large
- ✅ Error:
```json
{
  "ok": false,
  "code": "validation_error",
  "message": "Файл превышает лимит 50MB",
  "status": 413
}
```
- ✅ Файл НЕ загружен на диск

**Результат:** ⏳ PENDING

---

### 8.2. Batch > 200MB
**Шаги:**
1. Выбрать 5 файлов по 50MB (всего 250MB)
2. Попробовать загрузить

**Ожидаемый результат:**
- ✅ HTTP 413
- ✅ Error: "Превышен общий лимит 200MB"
- ✅ Ни один файл не загружен

**Результат:** ⏳ PENDING

---

## Тест 9: Санитизация Путей

### 9.1. Upload с опасным именем
**Шаги:**
1. Попробовать загрузить файл с именем: `../evil.jpg`

**Ожидаемый результат:**
- ✅ Имя нормализовано: `__evil.jpg`
- ✅ Файл сохранен в правильном месте (не вышел за пределы слота)

**Результат:** ⏳ PENDING

---

### 9.2. Создание авто с опасными символами
**Шаги:**
1. Попробовать создать авто:
   - Марка: `Test/../Evil`
   - Модель: `Car:Name`
   - VIN: (valid)

**Ожидаемый результат:**
- ✅ Папка создана с нормализованным именем: `Test__Evil Car_Name <VIN>`
- ✅ Путь безопасен

**Результат:** ⏳ PENDING

---

## Тест 10: ALL Region Блокировка

### 10.1. Попытка создать авто в ALL
**Шаги:**
1. Login как admin
2. Попробовать создать авто с region=ALL

**Ожидаемый результат:**
- ✅ HTTP 400
- ✅ Error:
```json
{
  "ok": false,
  "code": "REGION_ALL_FORBIDDEN",
  "message": "Нельзя создавать, загружать или блокировать в регионе ALL...",
  "status": 400
}
```

**Результат:** ⏳ PENDING

---

### 10.2. Попытка upload в ALL
**Шаги:**
1. Найти авто в ALL region (из архива)
2. Попробовать загрузить файл

**Ожидаемый результат:**
- ✅ HTTP 400
- ✅ Error: REGION_ALL_FORBIDDEN

**Результат:** ⏳ PENDING

---

## Тест 11: Ошибки в UI

### 11.1. Проверка отображения ошибок
**Шаги:**
1. Вызвать любую ошибку (например, создать авто без VIN)

**Ожидаемый результат:**
- ✅ В UI показывается:
  - HTTP статус (400)
  - Error code (`validation_error`)
  - Message на русском ("Необходимо указать...")
- ✅ НЕТ общих "Failed to..." без деталей

**Результат:** ⏳ PENDING

---

## Тест 12: Disk-DB Sync on Read

### 12.1. Sync при GET /api/cars
**Шаги:**
1. Создать авто через API
2. Удалить из БД вручную (SQL)
3. Вызвать GET /api/cars?region=R1

**Ожидаемый результат:**
- ✅ Авто найдено на диске
- ✅ Восстановлено в БД
- ✅ В response видно sync info

**Результат:** ⏳ PENDING

---

### 12.2. Sync при GET /api/cars/vin/:vin
**Шаги:**
1. Открыть карточку авто
2. Проверить что был вызван syncCar()

**Ожидаемый результат:**
- ✅ В логах: `[Sync] Starting sync for car: R1/VIN`
- ✅ В response: `last_sync_at` актуален

**Результат:** ⏳ PENDING

---

## Итоговая Таблица

| # | Тест | Статус | Детали |
|---|------|--------|--------|
| 1.1 | Admin Login | ⏳ | |
| 1.2 | User Login | ⏳ | |
| 2.1 | Admin Select Region | ⏳ | |
| 2.2 | Admin Create Car | ⏳ | |
| 3 | User Create Car | ⏳ | |
| 4 | 14 Slots Visible | ⏳ | |
| 5.1 | Upload Files | ⏳ | |
| 5.2 | Download ZIP | ⏳ | |
| 6.1 | Manual Delete _LOCK | ⏳ | |
| 6.2 | Manual Add _LOCK | ⏳ | |
| 7 | Archive to /ALL/ | ⏳ | |
| 8.1 | File > 50MB Block | ⏳ | |
| 8.2 | Batch > 200MB Block | ⏳ | |
| 9.1 | Sanitize Filename | ⏳ | |
| 9.2 | Sanitize Car Path | ⏳ | |
| 10.1 | Block Create in ALL | ⏳ | |
| 10.2 | Block Upload in ALL | ⏳ | |
| 11.1 | Error Display in UI | ⏳ | |
| 12.1 | Sync on GET /api/cars | ⏳ | |
| 12.2 | Sync on GET /api/cars/vin | ⏳ | |

---

## Примечания

### Как запускать
1. Скопируйте этот файл
2. Выполните каждый тест по порядку
3. Заполните статусы: ✅ PASS или ❌ FAIL
4. При FAIL добавьте детали ошибки

### Критические тесты (обязательно)
- Тест 2.2: Создание авто без ошибок
- Тест 4: 14 слотов видны
- Тест 6: Ручные изменения отражаются
- Тест 7: Archive работает
- Тест 8: Лимиты enforced
- Тест 10: ALL блокировка

### Если тест провалился
1. Записать endpoint, HTTP status, error message
2. Проверить логи сервера
3. Сообщить детали для фикса

---

**Дата создания:** 2026-02-07  
**Версия:** 1.0  
**Автор:** Production Fixes Team
